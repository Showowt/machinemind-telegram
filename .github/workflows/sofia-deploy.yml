name: Sofia Deploy Swarm

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project name'
        required: true
        type: string
      chat_id:
        description: 'Telegram chat ID'
        required: true
        type: string

jobs:
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ inputs.chat_id }}",
              "text": "ü§ñ <b>Sofia Deploy Swarm Initiated</b>\n\nüì¶ Project: <code>${{ inputs.project }}</code>\n\nüîÑ Spawning parallel agents:\n‚Ä¢ Validation Agent\n‚Ä¢ Build Agent\n‚Ä¢ Deploy Agent\n‚Ä¢ Config Agent",
              "parse_mode": "HTML"
            }'

  validate:
    runs-on: ubuntu-latest
    outputs:
      typescript: ${{ steps.ts.outcome }}
      deps: ${{ steps.deps.outcome }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - id: deps
        run: npm ci || npm install
        continue-on-error: true
      - id: ts
        run: npx tsc --noEmit
        continue-on-error: true

  build:
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.build.outcome }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci || npm install
      - id: build
        run: npm run build
        continue-on-error: true

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.status == 'success'
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      status: ${{ steps.deploy.outcome }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci || npm install
      - run: npm i -g vercel
      - id: deploy
        run: |
          URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes 2>&1 | grep -oE 'https://[^ ]+' | tail -1)
          echo "url=$URL" >> $GITHUB_OUTPUT
        continue-on-error: true

  config-check:
    runs-on: ubuntu-latest
    outputs:
      supabase: ${{ steps.check.outputs.supabase }}
      anthropic: ${{ steps.check.outputs.anthropic }}
      whatsapp: ${{ steps.check.outputs.whatsapp }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - id: check
        run: |
          SUPABASE=$(grep -q "SUPABASE" .env.example 2>/dev/null && echo "true" || echo "false")
          ANTHROPIC=$(grep -q "ANTHROPIC" .env.example 2>/dev/null && echo "true" || echo "false")
          WHATSAPP=$(grep -q "WHATSAPP\|TWILIO" .env.example 2>/dev/null && echo "true" || echo "false")
          echo "supabase=$SUPABASE" >> $GITHUB_OUTPUT
          echo "anthropic=$ANTHROPIC" >> $GITHUB_OUTPUT
          echo "whatsapp=$WHATSAPP" >> $GITHUB_OUTPUT
        continue-on-error: true

  report:
    needs: [validate, build, deploy, config-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send Report
        run: |
          TS="${{ needs.validate.outputs.typescript }}"
          BUILD="${{ needs.build.outputs.status }}"
          DEPLOY="${{ needs.deploy.outputs.status }}"
          URL="${{ needs.deploy.outputs.url }}"
          SUPABASE="${{ needs.config-check.outputs.supabase }}"
          ANTHROPIC="${{ needs.config-check.outputs.anthropic }}"

          TS_ICON=$([[ "$TS" == "success" ]] && echo "‚úÖ" || echo "‚ùå")
          BUILD_ICON=$([[ "$BUILD" == "success" ]] && echo "‚úÖ" || echo "‚ùå")
          DEPLOY_ICON=$([[ "$DEPLOY" == "success" ]] && echo "‚úÖ" || echo "‚ùå")
          SUP_ICON=$([[ "$SUPABASE" == "true" ]] && echo "‚úÖ" || echo "‚ö†Ô∏è")
          ANT_ICON=$([[ "$ANTHROPIC" == "true" ]] && echo "‚úÖ" || echo "‚ö†Ô∏è")

          if [[ "$DEPLOY" == "success" && -n "$URL" ]]; then
            STATUS="‚úÖ DEPLOYED"
            URL_LINE="üîó URL: $URL"
          else
            STATUS="‚ùå FAILED"
            URL_LINE="üîó Check logs for errors"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ inputs.chat_id }}\",
              \"text\": \"ü§ñ <b>Sofia Deploy: $STATUS</b>\n\nüì¶ Project: <code>${{ inputs.project }}</code>\n\n<b>Pipeline:</b>\n$TS_ICON TypeScript\n$BUILD_ICON Build\n$DEPLOY_ICON Deploy\n\n<b>Config:</b>\n$SUP_ICON Supabase\n$ANT_ICON Anthropic\n\n$URL_LINE\",
              \"parse_mode\": \"HTML\"
            }"
