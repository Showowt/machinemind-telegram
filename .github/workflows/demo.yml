name: Demo Deploy

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project name to demo'
        required: true
        type: string
      chat_id:
        description: 'Telegram chat ID for notifications'
        required: true
        type: string

jobs:
  demo:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ inputs.chat_id }}",
              "text": "üé¨ <b>Demo Deploy Started</b>\n\nProject: <code>${{ inputs.project }}</code>\nCreating preview deployment...",
              "parse_mode": "HTML"
            }'

      - name: Checkout project
        uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm i -g vercel

      - name: Pull Vercel Project
        run: |
          vercel pull --yes --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || true

      - name: Build Project
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        id: build
        continue-on-error: true

      - name: Deploy Preview
        id: deploy
        if: steps.build.outcome == 'success'
        run: |
          URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | grep -oE 'https://[^ ]+\.vercel\.app' | head -1)
          echo "url=$URL" >> $GITHUB_OUTPUT
          if [ -n "$URL" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Notify Success
        if: steps.deploy.outputs.success == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ inputs.chat_id }}",
              "text": "üé¨ <b>Demo Ready!</b>\n\nProject: <code>${{ inputs.project }}</code>\n\nüîó Preview: ${{ steps.deploy.outputs.url }}\n\n‚è±Ô∏è This is a preview deployment (not production)",
              "parse_mode": "HTML"
            }'

      - name: Notify Failure
        if: steps.build.outcome == 'failure' || steps.deploy.outputs.success != 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ inputs.chat_id }}",
              "text": "‚ùå <b>Demo Deploy Failed</b>\n\nProject: <code>${{ inputs.project }}</code>\n\nBuild: ${{ steps.build.outcome }}\n\nüîó <a href=\"https://github.com/Showowt/${{ inputs.project }}/actions\">View Logs</a>",
              "parse_mode": "HTML"
            }'
