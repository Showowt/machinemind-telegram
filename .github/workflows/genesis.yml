name: Genesis Build Swarm

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project name'
        required: true
        type: string
      chat_id:
        description: 'Telegram chat ID'
        required: true
        type: string

jobs:
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ inputs.chat_id }}",
              "text": "‚ö° <b>Genesis Swarm Activated</b>\n\nüì¶ Project: <code>${{ inputs.project }}</code>\n\nüîÑ Spawning parallel agents:\n‚Ä¢ TypeScript Agent\n‚Ä¢ Build Agent\n‚Ä¢ Lint Agent\n‚Ä¢ Security Agent",
              "parse_mode": "HTML"
            }'

  typescript:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outcome }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci || npm install
      - id: check
        run: npx tsc --noEmit
        continue-on-error: true

  build:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outcome }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci || npm install
      - id: check
        run: npm run build
        continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outcome }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci || npm install
      - id: check
        run: npm run lint 2>/dev/null || echo "No lint script"
        continue-on-error: true

  security:
    runs-on: ubuntu-latest
    outputs:
      vulns: ${{ steps.check.outputs.vulns }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci || npm install
      - id: check
        run: |
          VULNS=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.high + .metadata.vulnerabilities.critical' 2>/dev/null || echo "0")
          echo "vulns=$VULNS" >> $GITHUB_OUTPUT
        continue-on-error: true

  report:
    needs: [typescript, build, lint, security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send Report
        run: |
          TS="${{ needs.typescript.outputs.status }}"
          BUILD="${{ needs.build.outputs.status }}"
          LINT="${{ needs.lint.outputs.status }}"
          VULNS="${{ needs.security.outputs.vulns }}"

          TS_ICON=$([[ "$TS" == "success" ]] && echo "‚úÖ" || echo "‚ùå")
          BUILD_ICON=$([[ "$BUILD" == "success" ]] && echo "‚úÖ" || echo "‚ùå")
          LINT_ICON=$([[ "$LINT" == "success" ]] && echo "‚úÖ" || echo "‚ö†Ô∏è")
          SEC_ICON=$([[ "$VULNS" == "0" || -z "$VULNS" ]] && echo "‚úÖ" || echo "‚ö†Ô∏è $VULNS")

          if [[ "$TS" == "success" && "$BUILD" == "success" ]]; then
            STATUS="‚úÖ PASSED"
          else
            STATUS="‚ùå FAILED"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ inputs.chat_id }}\",
              \"text\": \"‚ö° <b>Genesis Complete: $STATUS</b>\n\nüì¶ Project: <code>${{ inputs.project }}</code>\n\n<b>Agent Reports:</b>\n$TS_ICON TypeScript\n$BUILD_ICON Build\n$LINT_ICON Lint\n$SEC_ICON Security\n\nüîó <a href=\\\"https://github.com/Showowt/${{ inputs.project }}/actions\\\">Full Logs</a>\",
              \"parse_mode\": \"HTML\"
            }"
