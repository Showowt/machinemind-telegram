name: Component Generator

on:
  workflow_dispatch:
    inputs:
      component_name:
        description: 'Component name (PascalCase, e.g., HeroSection)'
        required: true
        type: string
      project:
        description: 'Project name'
        required: true
        type: string
      chat_id:
        description: 'Telegram chat ID'
        required: true
        type: string

# Explicit minimal permissions
permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      # Use env vars to avoid shell injection
      COMPONENT_NAME: ${{ inputs.component_name }}
      PROJECT_NAME: ${{ inputs.project }}
      CHAT_ID: ${{ inputs.chat_id }}
    steps:
      - name: Validate Inputs
        run: |
          # Validate component name (PascalCase, alphanumeric only)
          if ! echo "$COMPONENT_NAME" | grep -qE '^[A-Z][A-Za-z0-9]{0,49}$'; then
            echo "Invalid component name: must be PascalCase, max 50 chars"
            exit 1
          fi
          # Validate project name (lowercase, alphanumeric with hyphens)
          if ! echo "$PROJECT_NAME" | grep -qE '^[a-z0-9][a-z0-9-]{0,99}$'; then
            echo "Invalid project name"
            exit 1
          fi
          # Validate chat_id (numeric only)
          if ! echo "$CHAT_ID" | grep -qE '^-?[0-9]+$'; then
            echo "Invalid chat ID"
            exit 1
          fi

      - name: Notify Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg cid "$CHAT_ID" \
              --arg name "$COMPONENT_NAME" \
              --arg proj "$PROJECT_NAME" \
              '{chat_id: $cid, text: "üß© <b>Component Generator</b>\n\nüì¶ Creating: <code>\($name)</code>\nüìÅ Project: <code>\($proj)</code>", parse_mode: "HTML"}')"

      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}

      - name: Generate Component Files
        run: |
          DIR="components"
          mkdir -p "$DIR"

          # Generate component file with proper escaping
          cat > "$DIR/${COMPONENT_NAME}.tsx" << 'COMPONENTEOF'
"use client";

import { useState } from "react";

interface COMPONENT_NAME_PLACEHOLDERProps {
  className?: string;
  children?: React.ReactNode;
}

export function COMPONENT_NAME_PLACEHOLDER({ className, children }: COMPONENT_NAME_PLACEHOLDERProps) {
  const [isLoading, setIsLoading] = useState(false);

  if (isLoading) {
    return <div className={className}>Loading...</div>;
  }

  return (
    <div className={className}>
      {children}
    </div>
  );
}
COMPONENTEOF

          # Safe replacement using sed with validated input
          sed -i "s/COMPONENT_NAME_PLACEHOLDER/$COMPONENT_NAME/g" "$DIR/${COMPONENT_NAME}.tsx"

      - name: Commit & Push
        run: |
          git config user.name "MachineMind Bot"
          git config user.email "bot@machinemind.ai"
          git add .
          git commit -m "feat($COMPONENT_NAME): add component [bot]" || exit 0
          git push

      - name: Notify Complete
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg cid "$CHAT_ID" \
              --arg name "$COMPONENT_NAME" \
              --arg proj "$PROJECT_NAME" \
              '{chat_id: $cid, text: "‚úÖ <b>Component Created!</b>\n\nüß© <code>\($name)</code>\nüìÅ <code>components/\($name).tsx</code>\n\n<b>Includes:</b>\n‚Ä¢ TypeScript interface\n‚Ä¢ Loading state\n‚Ä¢ Client component\n\nüîó <a href=\"https://github.com/Showowt/\($proj)/blob/main/components/\($name).tsx\">View on GitHub</a>", parse_mode: "HTML"}')"
