name: Security Audit Swarm

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project name'
        required: true
        type: string
      chat_id:
        description: 'Telegram chat ID'
        required: true
        type: string

jobs:
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ inputs.chat_id }}",
              "text": "üîç <b>Audit Swarm Activated</b>\n\nüì¶ Project: <code>${{ inputs.project }}</code>\n\nüîÑ Spawning parallel agents:\n‚Ä¢ Dependency Scanner\n‚Ä¢ Secret Detector\n‚Ä¢ Code Quality\n‚Ä¢ ZDBS Validator",
              "parse_mode": "HTML"
            }'

  dependencies:
    runs-on: ubuntu-latest
    outputs:
      critical: ${{ steps.scan.outputs.critical }}
      high: ${{ steps.scan.outputs.high }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci || npm install
      - id: scan
        run: |
          RESULT=$(npm audit --json 2>/dev/null || echo '{}')
          CRITICAL=$(echo "$RESULT" | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(echo "$RESULT" | jq '.metadata.vulnerabilities.high // 0')
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
        continue-on-error: true

  secrets:
    runs-on: ubuntu-latest
    outputs:
      found: ${{ steps.scan.outputs.found }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - id: scan
        run: |
          # Scan for hardcoded secrets
          FOUND=$(grep -rE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"][^'\"]{8,}" \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            . 2>/dev/null | grep -v node_modules | grep -v ".env" | wc -l | tr -d ' ')
          echo "found=$FOUND" >> $GITHUB_OUTPUT
        continue-on-error: true

  quality:
    runs-on: ubuntu-latest
    outputs:
      todos: ${{ steps.scan.outputs.todos }}
      any_types: ${{ steps.scan.outputs.any_types }}
      console_logs: ${{ steps.scan.outputs.console_logs }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - id: scan
        run: |
          TODOS=$(grep -rE "TODO|FIXME" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v node_modules | wc -l | tr -d ' ')
          ANY_TYPES=$(grep -rE ": any" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v node_modules | wc -l | tr -d ' ')
          CONSOLE_LOGS=$(grep -rE "console\.(log|debug)" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v node_modules | wc -l | tr -d ' ')
          echo "todos=$TODOS" >> $GITHUB_OUTPUT
          echo "any_types=$ANY_TYPES" >> $GITHUB_OUTPUT
          echo "console_logs=$CONSOLE_LOGS" >> $GITHUB_OUTPUT
        continue-on-error: true

  zdbs:
    runs-on: ubuntu-latest
    outputs:
      ts_strict: ${{ steps.scan.outputs.ts_strict }}
      env_example: ${{ steps.scan.outputs.env_example }}
      error_boundary: ${{ steps.scan.outputs.error_boundary }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Showowt/${{ inputs.project }}
          token: ${{ secrets.GH_PAT }}
      - id: scan
        run: |
          TS_STRICT=$(grep -q '"strict": true' tsconfig.json 2>/dev/null && echo "true" || echo "false")
          ENV_EXAMPLE=$([[ -f ".env.example" ]] && echo "true" || echo "false")
          ERROR_BOUNDARY=$(grep -r "error.tsx" app/ 2>/dev/null | wc -l | tr -d ' ')
          echo "ts_strict=$TS_STRICT" >> $GITHUB_OUTPUT
          echo "env_example=$ENV_EXAMPLE" >> $GITHUB_OUTPUT
          echo "error_boundary=$ERROR_BOUNDARY" >> $GITHUB_OUTPUT
        continue-on-error: true

  report:
    needs: [dependencies, secrets, quality, zdbs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Calculate Score & Report
        run: |
          CRITICAL="${{ needs.dependencies.outputs.critical }}"
          HIGH="${{ needs.dependencies.outputs.high }}"
          SECRETS="${{ needs.secrets.outputs.found }}"
          TODOS="${{ needs.quality.outputs.todos }}"
          ANY_TYPES="${{ needs.quality.outputs.any_types }}"
          CONSOLE_LOGS="${{ needs.quality.outputs.console_logs }}"
          TS_STRICT="${{ needs.zdbs.outputs.ts_strict }}"
          ENV_EXAMPLE="${{ needs.zdbs.outputs.env_example }}"

          # Calculate score
          SCORE=100
          [[ "$CRITICAL" -gt 0 ]] && SCORE=$((SCORE - 30))
          [[ "$HIGH" -gt 0 ]] && SCORE=$((SCORE - 15))
          [[ "$SECRETS" -gt 0 ]] && SCORE=$((SCORE - 25))
          [[ "$TODOS" -gt 5 ]] && SCORE=$((SCORE - 5))
          [[ "$ANY_TYPES" -gt 3 ]] && SCORE=$((SCORE - 10))
          [[ "$TS_STRICT" != "true" ]] && SCORE=$((SCORE - 10))
          [[ "$ENV_EXAMPLE" != "true" ]] && SCORE=$((SCORE - 5))

          # Grade
          if [[ $SCORE -ge 90 ]]; then GRADE="A+"; EMOJI="üèÜ";
          elif [[ $SCORE -ge 80 ]]; then GRADE="A"; EMOJI="‚úÖ";
          elif [[ $SCORE -ge 70 ]]; then GRADE="B"; EMOJI="‚ö†Ô∏è";
          elif [[ $SCORE -ge 60 ]]; then GRADE="C"; EMOJI="‚ö†Ô∏è";
          else GRADE="F"; EMOJI="‚ùå"; fi

          # Icons
          CRIT_ICON=$([[ "$CRITICAL" == "0" ]] && echo "‚úÖ" || echo "üî¥ $CRITICAL")
          HIGH_ICON=$([[ "$HIGH" == "0" ]] && echo "‚úÖ" || echo "üü† $HIGH")
          SEC_ICON=$([[ "$SECRETS" == "0" ]] && echo "‚úÖ" || echo "üî¥ $SECRETS found")
          TODO_ICON=$([[ "$TODOS" -le 5 ]] && echo "‚úÖ $TODOS" || echo "‚ö†Ô∏è $TODOS")
          ANY_ICON=$([[ "$ANY_TYPES" -le 3 ]] && echo "‚úÖ $ANY_TYPES" || echo "‚ö†Ô∏è $ANY_TYPES")
          STRICT_ICON=$([[ "$TS_STRICT" == "true" ]] && echo "‚úÖ" || echo "‚ùå")
          ENV_ICON=$([[ "$ENV_EXAMPLE" == "true" ]] && echo "‚úÖ" || echo "‚ùå")

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ inputs.chat_id }}\",
              \"text\": \"$EMOJI <b>Audit Complete: Grade $GRADE ($SCORE/100)</b>\n\nüì¶ Project: <code>${{ inputs.project }}</code>\n\n<b>üõ°Ô∏è Security:</b>\n$CRIT_ICON Critical vulns\n$HIGH_ICON High vulns\n$SEC_ICON Hardcoded secrets\n\n<b>üìä Quality:</b>\n$TODO_ICON TODOs\n$ANY_ICON any types\n\n<b>‚ö° ZDBS:</b>\n$STRICT_ICON TypeScript strict\n$ENV_ICON .env.example\n\nüîó <a href=\\\"https://github.com/Showowt/${{ inputs.project }}/actions\\\">Details</a>\",
              \"parse_mode\": \"HTML\"
            }"
